default_platform(:ios)

platform :ios do
  # --- ASC Key (CI: key_content, Local: key_filepath) ---
  private_lane :asc_key do
    if ENV["ASC_KEY_P8"] && !ENV["ASC_KEY_P8"].empty?
      app_store_connect_api_key(
        key_id: ENV.fetch("ASC_KEY_ID"),
        issuer_id: ENV.fetch("ASC_ISSUER_ID"),
        key_content: ENV.fetch("ASC_KEY_P8"),
        is_key_content_base64: false
      )
    else
      app_store_connect_api_key(
        key_id: ENV.fetch("ASC_KEY_ID"),
        issuer_id: ENV.fetch("ASC_ISSUER_ID"),
        key_filepath: ENV.fetch("ASC_KEY_P8_PATH")
      )
    end
  end

  # --- CI Keychain hardening (search list + unlock + partition list) ---
  private_lane :ci_keychain do
    keychain_name = ENV.fetch("MATCH_KEYCHAIN_NAME", "fastlane_tmp_keychain")
    pw            = ENV.fetch("MATCH_KEYCHAIN_PASSWORD")

    setup_ci(keychain_name: keychain_name)

    # --- 디버깅: 실제 생성된 파일 확인 ---
    sh("echo '--- ~/Library/Keychains ---' && ls -al $HOME/Library/Keychains || true")
    sh("echo '--- list-keychains (user) ---' && security list-keychains -d user || true")

    # setup_ci가 만든 keychain은 보통 아래 중 하나 형태
    candidates = [
      File.expand_path("~/Library/Keychains/#{keychain_name}-db"),
      File.expand_path("~/Library/Keychains/#{keychain_name}.keychain-db"),
      File.expand_path("~/Library/Keychains/#{keychain_name}"),
      File.expand_path("~/Library/Keychains/#{keychain_name}.keychain"),
    ]

    keychain_path = candidates.find { |p| File.exist?(p) }

    UI.user_error!("Could not find keychain file. Tried:\n#{candidates.join("\n")}") unless keychain_path

    # 1) search list에 넣기
    sh(%(security list-keychains -d user -s "#{keychain_path}" "$(security default-keychain | tr -d \\" )"))

    # 2) unlock
    sh(%(security unlock-keychain -p "#{pw}" "#{keychain_path}"))

    # 3) partition list (codesign 접근 허용)
    sh(%(security set-key-partition-list -S apple-tool:,apple: -s -k "#{pw}" "#{keychain_path}"))
  end


  desc "Smoke test"
  lane :smoke do
    scan(
      workspace: "BibleAtlas.xcworkspace",
      scheme: "BibleAtlas",
      clean: false,
      code_coverage: true,
      only_testing: [
        "BibleAtlasTests/MainViewModelTests/test_fetchGeoJsonRequired_success_shouldSetSelectedId_resetError_toggleLoading_andEmitGeoJson",
        "BibleAtlasTests/MainViewModelTests/test_fetchGeoJsonRequired_failure_shouldToggleLoading_emitError_andNotEmitGeoJson",
        "BibleAtlasTests/MainViewControllerTests/test_geoJson_emits_addsOverlaysAndAnnotations_withExpectedCounts",
        "BibleAtlasTests/MainViewControllerTests/test_renderGeoJson_setsVisibleMapRect_withMinSizeAndPadding",
        "BibleAtlasTests/MainViewControllerGeoJSONTests/test_geoJson_point_propertiesMapping_setsCustomAnnotationFields",
        "BibleAtlasTests/MainViewControllerGeoJSONTests/test_geoJson_multiGeometries_addsMultiOverlays_andSetsVisibleRect",
        "BibleAtlasTests/AuthorizedApiClientTests/test_401TriggersRefreshAndRetries",
        "BibleAtlasTests/AuthorizedApiClientTests/test_refreshFailure_propagatesUnauthorized"
      ]
    )
  end

  desc "Build & Upload to TestFlight (Release scheme)"
  lane :beta do
    asc_key
    ci_keychain

    match(
      type: "appstore",
      app_identifier: "com.seongyeon.bibleatlas.release",
      readonly: ENV["CI"] == "true",
      git_url: ENV.fetch("MATCH_GIT_URL"),
      git_basic_authorization: ENV.fetch("MATCH_GIT_BASIC_AUTHORIZATION"),
      keychain_name: ENV.fetch("MATCH_KEYCHAIN_NAME"),
      keychain_password: ENV.fetch("MATCH_KEYCHAIN_PASSWORD")
    )

    # 디버깅용 (필요시)
    # sh("security find-identity -v -p codesigning || true")

    increment_build_number(xcodeproj: "BibleAtlas.xcodeproj")

    build_app(
      workspace: "BibleAtlas.xcworkspace",
      scheme: "BibleAtlas(Release)",
      configuration: "Release",
      clean: false,
      export_method: "app-store",
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          "com.seongyeon.bibleatlas.release" => "match AppStore com.seongyeon.bibleatlas.release"
        }
      },
      xcargs: "ASSETCATALOG_COMPILER_GENERATE_ASSET_SYMBOLS=NO ENABLE_ON_DEMAND_RESOURCES=NO"
    )

    upload_to_testflight(skip_waiting_for_build_processing: true)
  end
end
