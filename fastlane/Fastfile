default_platform(:ios)

platform :ios do
  # --- ASC Key (CI: key_content, Local: key_filepath) ---
  private_lane :asc_key do
    if ENV["ASC_KEY_P8"] && !ENV["ASC_KEY_P8"].empty?
      app_store_connect_api_key(
        key_id: ENV.fetch("ASC_KEY_ID"),
        issuer_id: ENV.fetch("ASC_ISSUER_ID"),
        key_content: ENV.fetch("ASC_KEY_P8"),
        is_key_content_base64: false
      )
    else
      app_store_connect_api_key(
        key_id: ENV.fetch("ASC_KEY_ID"),
        issuer_id: ENV.fetch("ASC_ISSUER_ID"),
        key_filepath: ENV.fetch("ASC_KEY_P8_PATH")
      )
    end
  end

  private_lane :ci_keychain do
    keychain_name = ENV.fetch("MATCH_KEYCHAIN_NAME", "fastlane_tmp_keychain")
    pw            = ENV.fetch("MATCH_KEYCHAIN_PASSWORD")

    # 1) keychain 직접 생성 (항상 같은 경로/파일명)
    create_keychain(
      name: keychain_name,
      password: pw,
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    # 2) search list 확실히 설정
    keychain_path = File.expand_path("~/Library/Keychains/#{keychain_name}.keychain-db")
    sh(%(security list-keychains -d user -s "#{keychain_path}" "$(security default-keychain | tr -d \\" )"))

    # 3) partition list 설정 (codesign 접근 허용)
    sh(%(security set-key-partition-list -S apple-tool:,apple: -s -k "#{pw}" "#{keychain_path}"))

    # (디버깅) identity 확인
    sh("security find-identity -v -p codesigning #{keychain_path} || true")
  end



  desc "Smoke test"
  lane :smoke do
    scan(
      workspace: "BibleAtlas.xcworkspace",
      scheme: "BibleAtlas",
      clean: false,
      code_coverage: true,
      only_testing: [
        "BibleAtlasTests/MainViewModelTests/test_fetchGeoJsonRequired_success_shouldSetSelectedId_resetError_toggleLoading_andEmitGeoJson",
        "BibleAtlasTests/MainViewModelTests/test_fetchGeoJsonRequired_failure_shouldToggleLoading_emitError_andNotEmitGeoJson",
        "BibleAtlasTests/MainViewControllerTests/test_geoJson_emits_addsOverlaysAndAnnotations_withExpectedCounts",
        "BibleAtlasTests/MainViewControllerTests/test_renderGeoJson_setsVisibleMapRect_withMinSizeAndPadding",
        "BibleAtlasTests/MainViewControllerGeoJSONTests/test_geoJson_point_propertiesMapping_setsCustomAnnotationFields",
        "BibleAtlasTests/MainViewControllerGeoJSONTests/test_geoJson_multiGeometries_addsMultiOverlays_andSetsVisibleRect",
        "BibleAtlasTests/AuthorizedApiClientTests/test_401TriggersRefreshAndRetries",
        "BibleAtlasTests/AuthorizedApiClientTests/test_refreshFailure_propagatesUnauthorized"
      ]
    )
  end

  desc "Build & Upload to TestFlight (Release scheme)"
  lane :beta do
    asc_key
    ci_keychain

    match(
      type: "appstore",
      app_identifier: "com.seongyeon.bibleatlas.release",
      readonly: ENV["CI"] == "true",
      git_url: ENV.fetch("MATCH_GIT_URL"),
      git_basic_authorization: ENV.fetch("MATCH_GIT_BASIC_AUTHORIZATION"),
      keychain_name: ENV.fetch("MATCH_KEYCHAIN_NAME"),
      keychain_password: ENV.fetch("MATCH_KEYCHAIN_PASSWORD")
    )

    # 디버깅용 (필요시)
    # sh("security find-identity -v -p codesigning || true")

    increment_build_number(xcodeproj: "BibleAtlas.xcodeproj")

    build_app(
      workspace: "BibleAtlas.xcworkspace",
      scheme: "BibleAtlas(Release)",
      configuration: "Release",
      clean: false,
      export_method: "app-store",
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          "com.seongyeon.bibleatlas.release" => "match AppStore com.seongyeon.bibleatlas.release"
        }
      },
      xcargs: "ASSETCATALOG_COMPILER_GENERATE_ASSET_SYMBOLS=NO ENABLE_ON_DEMAND_RESOURCES=NO"
    )

    upload_to_testflight(skip_waiting_for_build_processing: true)
  end
end
