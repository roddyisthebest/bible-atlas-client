default_platform(:ios)

platform :ios do
  # --- ASC Key (CI: key_content, Local: key_filepath) ---
  private_lane :asc_key do
    if ENV["ASC_KEY_P8"] && !ENV["ASC_KEY_P8"].empty?
      app_store_connect_api_key(
        key_id: ENV.fetch("ASC_KEY_ID"),
        issuer_id: ENV.fetch("ASC_ISSUER_ID"),
        key_content: ENV.fetch("ASC_KEY_P8"),
        is_key_content_base64: false
      )
    else
      app_store_connect_api_key(
        key_id: ENV.fetch("ASC_KEY_ID"),
        issuer_id: ENV.fetch("ASC_ISSUER_ID"),
        key_filepath: ENV.fetch("ASC_KEY_P8_PATH")
      )
    end
  end

  private_lane :ci_keychain do
    keychain_name = ENV.fetch("MATCH_KEYCHAIN_NAME", "fastlane_tmp_keychain")
    pw            = ENV.fetch("MATCH_KEYCHAIN_PASSWORD")

    create_keychain(
      name: keychain_name,
      password: pw,
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    # 실제 생성된 경로 찾기
    candidates = [
      File.expand_path("~/Library/Keychains/#{keychain_name}-db"),
      File.expand_path("~/Library/Keychains/#{keychain_name}.keychain-db"),
      File.expand_path("~/Library/Keychains/#{keychain_name}.keychain"),
      File.expand_path("~/Library/Keychains/#{keychain_name}")
    ]
    keychain_path = candidates.find { |p| File.exist?(p) }
    UI.user_error!("Could not find created keychain file. Tried:\n#{candidates.join("\n")}") unless keychain_path

    # search list + unlock
    sh(%(security list-keychains -d user -s "#{keychain_path}" "$(security default-keychain | tr -d \\" )"))
    sh(%(security unlock-keychain -p "#{pw}" "#{keychain_path}"))

    # 이후 lane에서 keychain_path를 쓰려고 ENV에 박아둠
    ENV["CI_KEYCHAIN_PATH"] = keychain_path
  end
  private_lane :keychain_partition do
    pw = ENV.fetch("MATCH_KEYCHAIN_PASSWORD")
    keychain_path = ENV.fetch("CI_KEYCHAIN_PATH")

    # ✅ match가 cert/private key를 keychain에 넣은 다음에 실행해야 함
    sh(%(security set-key-partition-list -S apple-tool:,apple: -s -k "#{pw}" "#{keychain_path}"))

    # 확인용
    sh(%(security find-identity -v -p codesigning "#{keychain_path}" || true))
  end




  desc "Smoke test"
  lane :smoke do
    scan(
      workspace: "BibleAtlas.xcworkspace",
      scheme: "BibleAtlas",
      clean: false,
      code_coverage: true,
      only_testing: [
        "BibleAtlasTests/MainViewModelTests/test_fetchGeoJsonRequired_success_shouldSetSelectedId_resetError_toggleLoading_andEmitGeoJson",
        "BibleAtlasTests/MainViewModelTests/test_fetchGeoJsonRequired_failure_shouldToggleLoading_emitError_andNotEmitGeoJson",
        "BibleAtlasTests/MainViewControllerTests/test_geoJson_emits_addsOverlaysAndAnnotations_withExpectedCounts",
        "BibleAtlasTests/MainViewControllerTests/test_renderGeoJson_setsVisibleMapRect_withMinSizeAndPadding",
        "BibleAtlasTests/MainViewControllerGeoJSONTests/test_geoJson_point_propertiesMapping_setsCustomAnnotationFields",
        "BibleAtlasTests/MainViewControllerGeoJSONTests/test_geoJson_multiGeometries_addsMultiOverlays_andSetsVisibleRect",
        "BibleAtlasTests/AuthorizedApiClientTests/test_401TriggersRefreshAndRetries",
        "BibleAtlasTests/AuthorizedApiClientTests/test_refreshFailure_propagatesUnauthorized"
      ]
    )
  end

  desc "Build & Upload to TestFlight (Release scheme)"
  lane :beta do
    asc_key

    ci_keychain

    match(
      type: "appstore",
      app_identifier: "com.seongyeon.bibleatlas.release",
      readonly: ENV["CI"] == "true",
      git_url: ENV.fetch("MATCH_GIT_URL"),
      git_basic_authorization: ENV.fetch("MATCH_GIT_BASIC_AUTHORIZATION"),
      keychain_name: ENV.fetch("MATCH_KEYCHAIN_NAME"),
      keychain_password: ENV.fetch("MATCH_KEYCHAIN_PASSWORD")
    )

    # ✅ match 이후에 partition list
    keychain_partition

    increment_build_number(xcodeproj: "BibleAtlas.xcodeproj")

    build_app(
      workspace: "BibleAtlas.xcworkspace",
      scheme: "BibleAtlas(Release)",
      configuration: "Release",
      clean: false,
      export_method: "app-store",
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          "com.seongyeon.bibleatlas.release" => "match AppStore com.seongyeon.bibleatlas.release"
        }
      },
      xcargs: "ASSETCATALOG_COMPILER_GENERATE_ASSET_SYMBOLS=NO ENABLE_ON_DEMAND_RESOURCES=NO"
    )

    upload_to_testflight(skip_waiting_for_build_processing: true)
  end
end
